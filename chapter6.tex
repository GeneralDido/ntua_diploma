\chapter{Προεπεξεργασία δεδομένων}

\section{Δεδομένα}

Κατά την ανάλυση χρησιμοποιήθηκαν δεδομένα από την αγορά ηλεκτρικής ενέργειας, ώστε να παραχθεί το τελικό μοντέλο. Τα δεδομένα ήταν σε μορφή \tl{comma-separated values}(\tl{csv}). Ολόκληρη η ανάλυση και οι αλγόριθμοι που χρησιμοποιήθηκαν έγιναν στην γλώσσα \tl{python}. Το \tl{SMP} είναι η έξοδος \tl{y} που θέλουμε να προβλέψουμε με βάση τα χαρακτηριστικά \tl{X} που θα έχουμε ως είσοδο. 
\newline
Στα παραδείγματα που θα ακολουθήσουν παρουσιάζονται \tl{snippets} από κώδικα και όχι ολόκληρος ο κώδικας ώστε να γίνουν κατανοητές εύκολα οι έννοιες και να μην χαθεί ο αναγνώστης. Η μελέτη έγινε στην γλώσσα προγραμματισμού \tl{python} με χρήση βελτιστοποιημένων βιβλιοθηκών για \tl{machine learning} οι οποίες χρησιμοποιούνται από ερευνητές αλλά και μεγάλες εταιρίες του χώρου (\citealpsec{sklearn}).

\subsection{\tl{SMP}} Τιμή της ηλεκτρικής ενέργειας στη χονδρεμπορική αγορά στο διάστημα από 1/1/2008 έως 30/9/2013. Η πρώτη στήλη περιέχει ημερομηνίες ενώ οι υπόλοιπες 24 στήλες περιέχουν την τιμή της ηλεκτρικής ενέργειας για κάθε ώρα της ημέρας. Να σημειωθεί εδώ πως όλα τα χαρακτηριστικά που θα εξεταστούν στην ανάλυση αφορούν ημερήσιες τιμές στο διάστημα από 1/1/2009 έως 30/9/2013 επομένως το \tl{SMP} θα έχει περισσότερες γραμμές από ότι στο τελικό αρχείο. 

\begin{minted}[linenos]{python}
import pandas as pd
import datetime
path = "C:/Users/Dimitris/Desktop/diploma/data/"
df = pd.read_csv(path + "smp.csv", sep=',', converters={0:str2date})
df = df.set_index('Unnamed: 0')
runfile('C:/Users/Dimitris/Desktop/diploma/data/data2.py')
df.describe()
\end{minted}

\begin{figure}
  \makebox[\textwidth][c]{\includegraphics[width=1.4\textwidth]{fig/smp_describe.png}}%
  \caption{\tl{SMP}}
  \label{figure:10}
\end{figure}

\newpage

Έχουμε 24 στήλες δεδομένων και 2091 γραμμές. Όλες οι στήλες περιέχουν \tl{floating point} αριθμούς μη αρνητικούς. Παρατηρούμε πως η μέση τιμή του \tl{SMP} κυμαίνεται κοντά στα 50\euro παρουσιάζοντας κάποιες διακυμάνσεις μέσα στην ημέρα. Τις πρώτες ώρες είναι μικρότερη κοντά στα 40\euro ενώ αυξάνει τις επόμενες. Η τυπική απόκλιση είναι στα 25\euro με μέγιστες τιμές να μην ξεπερνούν τα 150\euro. Οι ελάχιστες τιμές του \tl{SMP} είναι μηδενικές, και αυτό οφείλεται στο γεγονός ότι έχουμε \tl{missing values} στο δείγμα μας τα οποία θα εξαφανίσουμε κατά την προεπεξεργασία. Κατά την ανάλυση θα θέλαμε τις μέσες ημερήσιες τιμές του \tl{SMP} ώστε να εξάγουμε τα κατάλληλα συμπεράσματα. 

\subsection{Χαρακτηριστικά}

Τα χαρακτηριστικά με βάση τα οποία θα γίνει η ανάλυσή μας παρουσιάζονται παρακάτω. Σημειώνεται πως στην ανάλυση μας απασχολούν τα συνολικά ημερήσια μεγέθη και όχι τα ωριαία.
\newline

\begin{description}
  \item[\tl{availability}] Δυναμικότητα μονάδων παραγωγής λιγνίτη κάθε μέρα σε \tl{MW}.
  \item[\tl{exports}] Συνολική ωριαία εξαγωγή ηλεκτρικής ενέργειας σε \tl{MW} από την Ελλάδα προς τους γείτονές της.
  \item[\tl{hydrogen}] Συνολική ωριαία παραγωγή υδροηλεκτρικών εργοστασίων σε \tl{MW}.
  \item[\tl{imports}]  Συνολική ωριαία εισαγωγή ηλεκτρικής ενέργειας σε \tl{MW} της Ελλάδας.
  \item[\tl{lignite}]  Συνολική ωριαία παραγωγή λιγνίτη σε \tl{MW}.
  \item[\tl{load\_forecast}] Συνολική ωριαία ζήτηση.
  \item[\tl{ngas}] Συνολική ωριαία παραγωγή φυσικού αερίου σε \tl{MW}.
  \item[\tl{res\_forecast}] Ωριαία πρόγνωση παραγωγής από ανανεώσιμες πηγές ενέργειας σε \tl{MW} (αρνητική ζήτηση).
  \item[\tl{waters}] Συνολική ωριαία παραγωγή από τα υποχρεωτικα νερα σε \tl{MW}.
  \item[\tl{waip}] Μηνιαία τιμή φυσικού αερίου.
\end{description}

\section{Προεπεξεργασία}

\subsection{Δημιουργία τελικού αρχείου δεδομένων}

Αρχικά θα δημιουργήσουμε ένα .\tl{csv} αρχείο το οποίο θα περιέχει τις συνολικές ημερήσιες τιμές των χαρακτηριστικών όπως και του \tl{SMP}. Για να το πετύχουμε αυτό αρκεί να πάρουμε το άθροισμα των τιμών κάθε σειράς του αρχείου και να δημιουργήσουμε μία νέα στήλη που να περιέχει τα αντίστοιχα χαρακτηριστικά. Ύστερα αυτή την στήλη την αποθηκεύουμε σε ένα νέο αρχείο το οποίο θα είναι το αρχείο με το οποίο θα γίνει η ανάλυση. Στην περίπτωση του \tl{SMP} χρειαζόμαστε τον μέσο όρο των χαρακτηριστικών κάθε σειράς ενώ στην περίπτωση του \tl{waip} θα έχουμε την ίδια τιμή σε ολόκληρο τον μήνα. Η υλοποίηση είναι πολύ εύκολη. Έστω για παράδειγμα ότι δημιουργούμε ένα νέο αρχείο \tl{out.csv} το οποίο θα περιέχει την νέα στήλη για μία τιμή \tl{X} και έστω ότι έχουμε δύο στηλες στο αρχικό αρχείο, την στήλη \tl{a} και την στήλη \tl{b}. Τότε:

\begin{minted}[linenos]{python}
df ['X'] = df['a'] + df['b']
out['X'] = df['X']
\end{minted}

Δημιουργούμε με παρόμοιο τρόπο το τελικό αρχείο το οποίο στην πρώτη στήλη περιέχει τις τιμές του \tl{SMP} και στις επόμενες τα χαρακτηριστικά οπότε καταλήγουμε να έχουμε το μοντέλο με απόκριση \tl{SMP} με \tl{p}-στοιχεία όπου το κάθε στοιχείο είναι μία μέρα μεταξύ 1/1/2008 και 30/9/2013 (σύνολο 1795 στοιχεία) και είσοδο τον πίνακα \tl{Y} με \tl{NxP} στοιχεία όπου N ο αριθμός των χαρακτηριστικών, δηλαδή 10. Φορτώνουμε το αρχείο και παίρνουμε τα χαρακτηριστικά που φαίνονται στο σχήμα \ref{figure:11}.

\begin{figure}
  \makebox[\textwidth][c]{\includegraphics[width=1.4\textwidth]{fig/teliko_describe.png}}%
  \caption{Χαρακτηριστικά μεταβλητών συστήματος}
  \label{figure:11}
\end{figure}

Το \tl{SMP} παρουσιάζει την συμπεριφορά που αναφέρθηκε στην προηγούμενη παράγραφο. Παρατηρούμε πως όλες οι μεταβλητές έχουν τιμές που λείπουν. Η συνολική δυναμικότητα που μας δίνουν οι μονάδες κάθε μέρα έχει μικρή τυπική απόκλιση, το οποίο σημαίνει πως η δυναμικότητα των εργοστασίων παραμένει σχεδόν σταθερή στη διάρκεια των ετών που μελετάμε.
\newpage

\subsection{Χειρισμός \tl{missing values}}

Για να μπορούν οι αλγόριθμοι που περιγράψαμε στο πρώτο μέρος της εργασίας να δουλέψουν, πρέπει να μην έχουμε τιμές που να λείπουν από τα δεδομένα μας. Υπάρχουν διάφοροι τρόποι χειρισμού μεταβλητών που λείπουν \citepri{saar2007handling}.
\begin{enumerate}
  \item Απόρριψη των δεδομένων που λείπουν. Είναι μία στρατηγική που χρησιμοποιείται συχνά από τους ερευνητές, ιδιαίτερα αν τα δεδομένα που λείπουν είναι τυχαία κατανεμημένα. Στην πράξη, η απόρριψη είναι κατάλληλη όταν είναι εφικτό να αρνηθούμε να κάνουμε μία πρόβλεψη σε συγκεκριμένα \tl{instances} του δείγματός μας. Στην περίπτωσή μας απαιτούνται προβλέψεις για όλα τα \tl{instances} των δεδομένων μας.
  \item Απόκτηση των δεδομένων που λείπουν. Υπάρχουν περιπτώσεις που η απόκτηση των δεδομένων είναι εφικτή.
  \item \tl Εκτίμηση της τιμής που λείπει (\tl{imputation}). Είτε μία τιμή που λείπει αντικαθίσταται από μία τιμή είτε η κατανομή των πιθανών τιμών που λείπουν εκτιμάται και δημιουργείται ένα μοντέλο που συνδυάζει προβλέψεις πιθανολογικά. Υπάρχουν διάφορα μοντέλα για \tl{imputation}.
  \begin{enumerate}
    \item \tl{(Predictive) Value Imputation (PVI)}: Τα \tl{missing values} αντικαθίσταται από εκτιμώμενες τιμές πριν τις βάλουμε στο μοντέλο. Οι σύνηθες περιπτώσεις είναι ο μέσος όρος, η διάμεσος ή η πιο συχνή τιμή.
    \item \tl{Distribution based Imputation (DBI)} Δεδομένης μίας διανομής γύρω από μία τιμή, μπορούν να γίνουν διάφορες προβλέψεις γύρω από την τιμή αυτή και η κάθε πρόβλεψη να έχει ένα βάρος, και το αποτέλεσμα να είναι ο συνδυασμός των προβλέψεων αυτών. Παράδειγμα είναι ο αλγόριθμος \tl{C}4.5.
    \item \tl{Unique value imputation}: Αντί να γίνεται αντικατάσταση όλων των μεταβλητών με την ίδια τιμή, υπάρχουν μοντέλα που προσδιορίζουν μοναδικά τις τιμές που μπορεί να προκύψουν. Αυτά τα μοντέλα θεωρούνται καλύτερα όταν η μεταβλητή που λείπει εξαρτάται περισσότερο από την τιμή των μεταβλητών της κλάσης που ανήκει η τιμή.
	\end{enumerate}
\end{enumerate}

Η βιβλιοθήκη \tl{sklearn} έχει διάφορους αλγόριθμους για \tl{machine learning} και είναι η κύρια βιβλιοθήκη που χρησιμοποιείται στην ανάλυσή μας. Έχει επίσης βιβλιοθήκες για \tl{preprocessing} δεδομένων. Η κλάση \tl{Imputer} κάνει predictive value imputation στα missing values, σύμφωνα με κάποιο κριτήριο. Το \tl{default} κριτήριο είναι ο μέσος όρος των τιμών, πράγμα που χρησιμοποιείται εδώ. Επομένως με τις ακόλουθες εντολές δίνουμε τιμές στα \tl{missing values} και ταυτόχρονα τα φέρνουμε σε μορφή πίνακα ώστε να μπορούν να διαβαστούν από αλγορίθμους που θα χρησιμοποιηθούν.

\begin{minted}[linenos]{python}
from sklearn.preprocessing import Imputer
imp = Imputer(missing_values='NaN', strategy='mean', axis=0,verbose=0)
imp.fit(df)
train_imp = imp.transform(df)
\end{minted}

\subsection{\tl{Train and Validation Sets}}

Επόμενο βήμα είναι να χωρίσουμε τα δεδομένα που έχουμε σε δύο σετ: μάθησης (\tl{training}) και επικύρωσης (\tl{validation}). Στο πρώτο οι αλγόριθμοι θα πάρουν τα δεδομένα και την αντίστοιχη έξοδο και θα δημιουργήσουν \tl{patterns} που ουσιαστικά θα είναι τα δέντρα εκμάθησης, και στο δεύτερο θα κάνουν προβλέψεις με βάση το μοντέλο που θα έχουν δημιουργήσει. Το παραπάνω γίνεται εύκολα με την βοήθεια της συνάρτησης \tl{train\_test\_split} της \tl{sklearn}.

\begin{minted}[linenos]{python}
from sklearn.cross_validation import train_test_split as ts
dataset = train_imp[:,1:]
smp = train_imp[:,0]
dataset_train, dataset_test,smp_train, smp_test= ts(dataset,smp, test_size=0.33)
\end{minted}

Στο παραπάνω παράδειγμα έχουμε δημιουργήσει δύο πίνακες, όπου ο πρώτος περιέχει μόνο το \tl{SMP} και ο δεύτερος τα χαρακτηριστικά και ύστερα δημιουργούμε δύο σετ από το καθένα. Με την παράμετρο \tl{random state} μπορούμε να δημιουργήσουμε αρχεία που θα λαμβάνουν τις μεταβλητές τους με τυχαίο τρόπο, όπως και έγινε στην ανάλυση. Επίσης το δείγμα για ανάλυση είναι 67\% ενώ το αντίστοιχο για επικύρωση 33\% ώστε να πετύχουμε καλύτερο \tl{fit} του μοντέλου.
 
\newpage
\thispagestyle{empty}